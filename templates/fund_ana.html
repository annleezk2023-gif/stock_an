{% extends "stock_basic_search.html" %}
{% set action_url = "/fund_ana" %}
{% block content %}
        <!-- 数据表格 -->
        <table class="fund-ana-table">
            <!-- 表格列标题行 -->
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="width: 100px;">行业</th>
                    <th style="width: 800px;">TOP股票</th>
                    <th style="width: 60px;">标签</th>
                    <th style="width: 300px;">PE/PS分位1/3/5年</th>
                    <th style="width: 450px;">备注</th>
                    <th style="width: 50px;">操作</th>
                </tr>
            </thead>

            <!-- 表格数据行 -->
            <tbody id="fundTableBody">
                {% if fund_anas %}
                    {% for fund in fund_anas %}
                        <tr>
                            <td>{{ fund.industry }}</td>
                            <td>
                                {% if fund.top_stock %}
                                    <strong><a href="http://localhost:5000/stock_basic?status=1&bukan=1&ana_type=1&query_all=1&industry={{ fund.industry }}" target="_blank">TOP股票</a>
                                        <a href="http://localhost:5000/stock_basic?status=1&bukan=1&query_all=1&industry={{ fund.industry }}" target="_blank">备注</a>：</strong>
                                    {% set codes = fund.top_stock.split(',') %}
                                    {% for code in codes %}
                                        {% set stock_info = stock_dict.get(code) %}
                                        {% if stock_info %}
                                            <a href="/stock_trade/{{ code }}" target="_blank">{{ stock_info.code_name }}</a>{% if not loop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                                {% if fund.fenghong_3_stock %}
                                    <br/><strong><a href="http://localhost:5000/stock_basic?status=1&bukan=1&ana_type=1&query_all=1&auto_tag=3股息&industry={{ fund.industry }}" target="_blank">3股息</a>
                                        <a href="http://localhost:5000/stock_basic?status=1&bukan=1&query_all=1&auto_tag=3股息&industry={{ fund.industry }}" target="_blank">备注</a>：</strong>
                                    {% set fenghong_3_codes = fund.fenghong_3_stock.split(',') %}
                                    {% for code in fenghong_3_codes %}
                                        {% set stock_info = stock_dict.get(code) %}
                                        {% if stock_info %}
                                            <a href="/stock_trade/{{ code }}" target="_blank">{{ stock_info.code_name }}</a>{% if not loop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if fund.growth_15_stock %}
                                    <br/><strong><a href="http://localhost:5000/stock_basic?status=1&bukan=1&ana_type=1&query_all=1&auto_tag=15成长&industry={{ fund.industry }}" target="_blank">15成长</a>
                                        <a href="http://localhost:5000/stock_basic?status=1&bukan=1&query_all=1&auto_tag=15成长&industry={{ fund.industry }}" target="_blank">备注</a>：</strong>
                                    {% set growth_15_codes = fund.growth_15_stock.split(',') %}
                                    {% for code in growth_15_codes %}
                                        {% set stock_info = stock_dict.get(code) %}
                                        {% if stock_info %}
                                            <a href="/stock_trade/{{ code }}" target="_blank">{{ stock_info.code_name }}</a>{% if not loop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if fund.growth_5_stock %}
                                    <br/><strong><a href="http://localhost:5000/stock_basic?status=1&bukan=1&ana_type=1&query_all=1&auto_tag=5成长大股&industry={{ fund.industry }}" target="_blank">5成长大股</a>
                                        <a href="http://localhost:5000/stock_basic?status=1&bukan=1&query_all=1&auto_tag=5成长大股&industry={{ fund.industry }}" target="_blank">备注</a>：</strong>
                                    {% set growth_5_codes = fund.growth_5_stock.split(',') %}
                                    {% for code in growth_5_codes %}
                                        {% set stock_info = stock_dict.get(code) %}
                                        {% if stock_info %}
                                            <a href="/stock_trade/{{ code }}" target="_blank">{{ stock_info.code_name }}</a>{% if not loop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if fund.fenghong_1_growth_5_stock %}
                                    <br/><strong><a href="http://localhost:5000/stock_basic?status=1&bukan=1&ana_type=1&query_all=1&auto_tag=1股息5成长&industry={{ fund.industry }}" target="_blank">1股息5成长</a>
                                        <a href="http://localhost:5000/stock_basic?status=1&bukan=1&query_all=1&auto_tag=1股息5成长&industry={{ fund.industry }}" target="_blank">备注</a>：</strong>
                                    {% set fenghong_1_growth_5_codes = fund.fenghong_1_growth_5_stock.split(',') %}
                                    {% for code in fenghong_1_growth_5_codes %}
                                        {% set stock_info = stock_dict.get(code) %}
                                        {% if stock_info %}
                                            <a href="/stock_trade/{{ code }}" target="_blank">{{ stock_info.code_name }}</a>{% if not loop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td>
                                {% if fund.sort_tag %}
                                    {% if fund.sort_tag == 3 %}
                                        <span style="background-color: #FF5722; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 4px;">重点</span>
                                    {% elif fund.sort_tag == 2 %}
                                        <span style="background-color: #FF9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 4px;">观察</span>
                                    {% elif fund.sort_tag == 1 %}
                                        <span style="background-color: #9E9E9E; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 4px;">不看</span>
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <strong>3股息</strong>
                                PE
                                {% if fund.fenghong_3_pe_year_1_percent %}
                                    {% if fund.fenghong_3_pe_year_1_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.fenghong_3_pe_year_1_percent) }}%</span>
                                    {% elif fund.fenghong_3_pe_year_1_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.fenghong_3_pe_year_1_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.fenghong_3_pe_year_1_percent) }}%
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                                {% if fund.fenghong_3_pe_year_3_percent %}
                                    
                                    {% if fund.fenghong_3_pe_year_3_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.fenghong_3_pe_year_3_percent) }}%</span>
                                    {% elif fund.fenghong_3_pe_year_3_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.fenghong_3_pe_year_3_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.fenghong_3_pe_year_3_percent) }}%
                                    {% endif %}
                                {% endif %}
                                {% if fund.fenghong_3_pe_year_5_percent %}
                                    
                                    {% if fund.fenghong_3_pe_year_5_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.fenghong_3_pe_year_5_percent) }}%</span>
                                    {% elif fund.fenghong_3_pe_year_5_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.fenghong_3_pe_year_5_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.fenghong_3_pe_year_5_percent) }}%
                                    {% endif %}
                                {% endif %}
                                <br/>
                                PS
                                {% if fund.fenghong_3_ps_year_1_percent %}
                                    
                                    {% if fund.fenghong_3_ps_year_1_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.fenghong_3_ps_year_1_percent) }}%</span>
                                    {% elif fund.fenghong_3_ps_year_1_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.fenghong_3_ps_year_1_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.fenghong_3_ps_year_1_percent) }}%
                                    {% endif %}
                                {% endif %}
                                {% if fund.fenghong_3_ps_year_3_percent %}
                                    
                                    {% if fund.fenghong_3_ps_year_3_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.fenghong_3_ps_year_3_percent) }}%</span>
                                    {% elif fund.fenghong_3_ps_year_3_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.fenghong_3_ps_year_3_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.fenghong_3_ps_year_3_percent) }}%
                                    {% endif %}
                                {% endif %}
                                {% if fund.fenghong_3_ps_year_5_percent %}
                                    
                                    {% if fund.fenghong_3_ps_year_5_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.fenghong_3_ps_year_5_percent) }}%</span>
                                    {% elif fund.fenghong_3_ps_year_5_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.fenghong_3_ps_year_5_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.fenghong_3_ps_year_5_percent) }}%
                                    {% endif %}
                                {% endif %}
                                <br/>
                                <strong>15成长</strong>PE
                                {% if fund.growth_15_pe_year_1_percent %}
                                    {% if fund.growth_15_pe_year_1_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.growth_15_pe_year_1_percent) }}%</span>
                                    {% elif fund.growth_15_pe_year_1_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.growth_15_pe_year_1_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.growth_15_pe_year_1_percent) }}%
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                                {% if fund.growth_15_pe_year_3_percent %}
                                    
                                    {% if fund.growth_15_pe_year_3_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.growth_15_pe_year_3_percent) }}%</span>
                                    {% elif fund.growth_15_pe_year_3_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.growth_15_pe_year_3_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.growth_15_pe_year_3_percent) }}%
                                    {% endif %}
                                {% endif %}
                                {% if fund.growth_15_pe_year_5_percent %}
                                    
                                    {% if fund.growth_15_pe_year_5_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.growth_15_pe_year_5_percent) }}%</span>
                                    {% elif fund.growth_15_pe_year_5_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.growth_15_pe_year_5_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.growth_15_pe_year_5_percent) }}%
                                    {% endif %}
                                {% endif %}
                                <br/>
                                PS
                                {% if fund.growth_15_ps_year_1_percent %}
                                    
                                    {% if fund.growth_15_ps_year_1_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.growth_15_ps_year_1_percent) }}%</span>
                                    {% elif fund.growth_15_ps_year_1_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.growth_15_ps_year_1_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.growth_15_ps_year_1_percent) }}%
                                    {% endif %}
                                {% endif %}
                                {% if fund.growth_15_ps_year_3_percent %}
                                    
                                    {% if fund.growth_15_ps_year_3_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.growth_15_ps_year_3_percent) }}%</span>
                                    {% elif fund.growth_15_ps_year_3_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.growth_15_ps_year_3_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.growth_15_ps_year_3_percent) }}%
                                    {% endif %}
                                {% endif %}
                                {% if fund.growth_15_ps_year_5_percent %}
                                    
                                    {% if fund.growth_15_ps_year_5_percent < 20 %}
                                        <span style="color: green;">{{ '%.1f' | format(fund.growth_15_ps_year_5_percent) }}%</span>
                                    {% elif fund.growth_15_ps_year_5_percent > 80 %}
                                        <span style="color: red;">{{ '%.1f' | format(fund.growth_15_ps_year_5_percent) }}%</span>
                                    {% else %}
                                        {{ '%.1f' | format(fund.growth_15_ps_year_5_percent) }}%
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <div style="word-wrap: break-word;">
                                    备注：{{ fund.remark or '-' }}<br/>
                                    风险备注：{{ fund.risk_memo or '-' }}
                                </div>
                            </td>
                            <td>
                                <button onclick="editFund({{ fund.id }}, '{{ fund.industry }}')" data-sort-tag="{{ fund.sort_tag }}" data-remark="{{ fund.remark or '' }}" data-risk-memo="{{ fund.risk_memo or '' }}" style="background-color: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; display: block;">编辑</button>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px;">暂无数据</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    
    <!-- 编辑弹窗 -->
    <div id="fundModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 20px; border-radius: 8px; width: 700px; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
            <h2>编辑行业 - <span id="modalIndustryName"></span></h2>
            <input type="hidden" id="modalFundId">
            
            <div style="margin: 20px 0;">
                排序标签：
                <div id="sortTags" style="display: flex; gap: 10px;">
                    <label style="display: inline-flex; align-items: center; background-color: #f0f0f0; padding: 8px 12px; border-radius: 4px;">
                        <input type="radio" name="sort_tag" value="3" style="margin-right: 5px;">重点
                    </label>
                    <label style="display: inline-flex; align-items: center; background-color: #f0f0f0; padding: 8px 12px; border-radius: 4px;">
                        <input type="radio" name="sort_tag" value="2" style="margin-right: 5px;">观察
                    </label>
                    <label style="display: inline-flex; align-items: center; background-color: #f0f0f0; padding: 8px 12px; border-radius: 4px;">
                        <input type="radio" name="sort_tag" value="1" style="margin-right: 5px;">不看
                    </label>
                    <label style="display: inline-flex; align-items: center; background-color: #f0f0f0; padding: 8px 12px; border-radius: 4px;">
                        <input type="radio" name="sort_tag" value="0" style="margin-right: 5px;">无
                    </label>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <p>备注：</p>
                <textarea id="modalRemark" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" maxlength="1000"></textarea>
                <p style="margin-top: 10px;">风险备注：</p>
                <textarea id="modalRiskMemo" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" maxlength="1000"></textarea>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="saveFund()" style="background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">保存</button>
                <button onclick="closeModal()" style="background-color: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">取消</button>
            </div>
        </div>
    </div>
    
    <script>
        // 编辑行业信息
        function editFund(fundId, industryName) {
            document.getElementById('modalFundId').value = fundId;
            document.getElementById('modalIndustryName').textContent = industryName;
            
            // 获取当前数据
            const row = document.querySelector(`button[onclick*="${fundId}"]`).closest('tr');
            const sortTag = row.querySelector('td:nth-child(3)').textContent.trim();
            const remarkCell = row.querySelector('td:nth-child(5)');
            
            let remark = '';
            let riskMemo = '';
            if (remarkCell) {
                const cellText = remarkCell.textContent;
                const parts = cellText.split('风险备注：');
                if (parts.length > 1) {
                    const remarkPart = parts[0].replace('备注：', '').trim();
                    remark = remarkPart === '-' ? '' : remarkPart;
                    riskMemo = parts[1].trim() === '-' ? '' : parts[1].trim();
                } else {
                    const remarkPart = cellText.replace('备注：', '').trim();
                    remark = remarkPart === '-' ? '' : remarkPart;
                }
            }
            
            // 设置排序标签
            const sortTagRadios = document.querySelectorAll('input[name="sort_tag"]');
            sortTagRadios.forEach(radio => {
                radio.checked = false;
            });
            
            if (sortTag.includes('重点')) {
                document.querySelector('input[name="sort_tag"][value="3"]').checked = true;
            } else if (sortTag.includes('观察')) {
                document.querySelector('input[name="sort_tag"][value="2"]').checked = true;
            } else if (sortTag.includes('不看')) {
                document.querySelector('input[name="sort_tag"][value="1"]').checked = true;
            } else {
                document.querySelector('input[name="sort_tag"][value="0"]').checked = true;
            }
            
            // 设置备注
            document.getElementById('modalRemark').value = remark || '';
            document.getElementById('modalRiskMemo').value = riskMemo || '';
            
            // 显示弹窗
            document.getElementById('fundModal').style.display = 'flex';
        }
        
        // 保存行业信息
        function saveFund() {
            const fundId = document.getElementById('modalFundId').value;
            const sortTagRadio = document.querySelector('input[name="sort_tag"]:checked');
            const sortTag = sortTagRadio ? parseInt(sortTagRadio.value) : null;
            const remark = document.getElementById('modalRemark').value;
            const riskMemo = document.getElementById('modalRiskMemo').value;
            
            // 验证备注长度
            if (remark.length > 1000) {
                alert('备注不能超过1000个文字');
                return;
            }
            if (riskMemo.length > 1000) {
                alert('风险备注不能超过1000个文字');
                return;
            }
            
            // 发送保存请求
            fetch(`/fund_ana/save/${fundId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sort_tag: sortTag,
                    remark: remark,
                    risk_memo: riskMemo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    updateRow(fundId, sortTag, remark, riskMemo);
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                alert('保存失败: ' + error);
            });
        }
        
        // 更新行数据
        function updateRow(fundId, sortTag, remark, riskMemo) {
            const row = document.querySelector(`button[onclick*="${fundId}"]`).closest('tr');
            if (!row) return;
            
            const tagCell = row.querySelector('td:nth-child(3)');
            const remarkCell = row.querySelector('td:nth-child(5)');
            
            if (tagCell) {
                let tagHtml = '';
                if (sortTag === 3) {
                    tagHtml = '<span style="background-color: #FF5722; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 4px;">重点</span>';
                } else if (sortTag === 2) {
                    tagHtml = '<span style="background-color: #FF9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 4px;">观察</span>';
                } else if (sortTag === 1) {
                    tagHtml = '<span style="background-color: #9E9E9E; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 4px;">不看</span>';
                } else {
                    tagHtml = '-';
                }
                tagCell.innerHTML = tagHtml;
            }
            
            if (remarkCell) {
                const remarkDiv = remarkCell.querySelector('div');
                if (remarkDiv) {
                    const safeRemark = remark.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const safeRiskMemo = riskMemo.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    remarkDiv.innerHTML = `备注：${safeRemark || '-'}<br/>风险备注：${safeRiskMemo || '-'}`;
                }
            }
        }
        
        // 关闭弹窗
        function closeModal() {
            document.getElementById('fundModal').style.display = 'none';
        }
        
        // 点击弹窗外部关闭
        document.getElementById('fundModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
{% endblock %}
