<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ stock_code }} - {{ stock_name }} æ—¥Kæ•°æ®</title>
    <!-- æ·»åŠ Chart.jså’Œmoment.jsåº“ -->
    <!-- ç¡®ä¿æ­£ç¡®çš„åŠ è½½é¡ºåºï¼šChart.js -> Moment.js -> é€‚é…å™¨ -> æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
<!-- Chart.js é…ç½® -->
<script>
    // ç®€å•ç›´æ¥çš„èµ„æºåŠ è½½æ£€æŸ¥

    
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„èµ„æºåŠ è½½çŠ¶æ€å¯¹è±¡
    window.resourceStatus = {
        chartjs: {
            loaded: false,
            version: null,
            loadedTime: null
        },
        moment: {
            loaded: false,
            version: null,
            loadedTime: null
        },
        plugins: {
            zoom: false,
            adapter: false
        },
        loadStartTime: Date.now()
    };
    
    // æ·»åŠ ç›´æ¥çš„å†…è”æ£€æŸ¥å‡½æ•°
    function checkChartJsDirectly() {
        const currentTime = Date.now() - window.resourceStatus.loadStartTime;
        
        // æ£€æŸ¥Chart.js
        if (typeof Chart !== 'undefined' && !window.resourceStatus.chartjs.loaded) {
            window.resourceStatus.chartjs.loaded = true;
            window.resourceStatus.chartjs.version = Chart.version || 'æœªçŸ¥ç‰ˆæœ¬';
            window.resourceStatus.chartjs.loadedTime = currentTime;

            
            // æ£€æŸ¥ç¼©æ”¾æ’ä»¶
            try {
                const hasZoom = (Chart.defaults && Chart.defaults.plugins && Chart.defaults.plugins.zoom) ||
                              (Chart.plugins && typeof Chart.plugins.getAll === 'function' && 
                               Chart.plugins.getAll().some(p => p.id === 'zoom'));
                window.resourceStatus.plugins.zoom = hasZoom;

            } catch (e) {

            }
            
            // æ£€æŸ¥æ—¥æœŸé€‚é…å™¨
            try {
                const hasAdapter = (Chart._adapters && Chart._adapters.date) || 
                                  (Chart.adapters && Chart.adapters.date);
                window.resourceStatus.plugins.adapter = hasAdapter;

            } catch (e) {

            }
        }
        
        // æ£€æŸ¥Moment.js
        if (typeof moment !== 'undefined' && !window.resourceStatus.moment.loaded) {
            window.resourceStatus.moment.loaded = true;
            window.resourceStatus.moment.version = moment.version || 'æœªçŸ¥ç‰ˆæœ¬';
            window.resourceStatus.moment.loadedTime = currentTime;

        }
        
        // æ‰“å°èµ„æºçŠ¶æ€æ‘˜è¦

        
        return window.resourceStatus.chartjs.loaded && window.resourceStatus.moment.loaded;
    }
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    checkChartJsDirectly();
    
    // å†æ·»åŠ ä¸€ä¸ªç®€å•çš„é—´éš”æ£€æŸ¥ï¼Œç¡®ä¿æ•è·åŠ¨æ€åŠ è½½
    let checkCount = 0;
    const maxChecks = 10;
    const checkInterval = setInterval(() => {
        checkCount++;

        
        const allLoaded = checkChartJsDirectly();
        
        if (allLoaded || checkCount >= maxChecks) {
            clearInterval(checkInterval);

            
            // å¦‚æœChart.jsä»æœªåŠ è½½ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (!window.resourceStatus.chartjs.loaded) {

            }
        }
    }, 500);
    
    // ç®€åŒ–çš„äº‹ä»¶ç›‘å¬
    document.addEventListener('DOMContentLoaded', function() {
    
        checkChartJsDirectly();
    });
    
    window.addEventListener('load', function() {
        console.log('âœ… æ‰€æœ‰é¡µé¢èµ„æºå·²åŠ è½½å®Œæˆ');
        checkChartJsDirectly();
    });
</script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            max-width: 1920px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            max-width: 1920px;
            border-collapse: collapse;
            margin: 20px 0;
            table-layout: fixed;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        th {
            background-color: #2196F3;
            color: white;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .back-link {
            text-align: center;
            margin-top: 20px;
        }
        .back-link a {
            color: #2196F3;
            text-decoration: none;
        }
        .back-link a:hover {
            text-decoration: underline;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .stock-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 5px;
        }
        .pagination {
            display: none; /* ä¸åˆ†é¡µ */
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .chart-controls {
            text-align: center;
            margin-bottom: 10px;
        }
        .chart-controls button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .chart-controls button:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="stock-info">
            {{ stock_name }} ({{ stock_code }}) æ—¥Kæ•°æ®
            æ•°æ®æ€»é‡: {{ total_count }} æ¡
            <form method="get" action="/stock_trade/{{ stock_code }}">
                <label for="lastTradeDate">æœ€åäº¤æ˜“æ—¥ï¼š</label>
                <input type="date" id="lastTradeDate" name="lastTradeDate" value="{{ lastTradeDate }}" required>
                <button type="submit" style="padding: 4px 8px; background-color: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">æäº¤</button>
            </form>
        </div>
        
        <!-- å›¾è¡¨å®¹å™¨ -->
        <div class="chart-controls">
            <label for="timeUnit">æ—¶é—´å•ä½ï¼š</label>
            <select id="timeUnit">
                <option value="day">æ—¥</option>
                <option value="week">å‘¨</option>
                <option value="month">æœˆ</option>
                <option value="quarter">å­£</option>
            </select>
            <button id="resetZoom">é‡ç½®ç¼©æ”¾</button>
        </div>
        <div class="chart-container">
            <canvas id="klineChart"></canvas>
        </div>

        <!-- 1å¹´PE&PS&PBåˆ†ä½å€¼å›¾è¡¨ -->
        <div class="chart-container" style="height: 400px; width: 100%; margin: 20px 0; border: 1px solid #eee; border-radius: 4px;">
            <h3 style="text-align: center;">1å¹´PE&PS&PBåˆ†ä½å€¼</h3>
            <canvas id="oneYearPercentChart"></canvas>
        </div>

        <!-- 3å¹´PE&PS&PBåˆ†ä½å€¼å›¾è¡¨ -->
        <div class="chart-container" style="height: 400px; width: 100%; margin: 20px 0; border: 1px solid #eee; border-radius: 4px;">
            <h3 style="text-align: center;">3å¹´PE&PS&PBåˆ†ä½å€¼</h3>
            <canvas id="threeYearPercentChart"></canvas>
        </div>

        <!-- 5å¹´PE&PS&PBåˆ†ä½å€¼å›¾è¡¨ -->
        <div class="chart-container" style="height: 400px; width: 100%; margin: 20px 0; border: 1px solid #eee; border-radius: 4px;">
            <h3 style="text-align: center;">5å¹´PE&PS&PBåˆ†ä½å€¼</h3>
            <canvas id="fiveYearPercentChart"></canvas>
        </div>

        <div class="table-container">
            <table class="stock-trade-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">æ—¥æœŸ</th>
                        <th style="width: 60px;">å¼€ç›˜ä»·</th>
                        <th style="width: 60px;">æœ€é«˜</th>
                        <th style="width: 60px;">æœ€ä½</th>
                        <th style="width: 60px;">æ”¶ç›˜ä»·</th>
                        <th style="width: 120px;">æˆäº¤é‡</th>
                        <th style="width: 150px;">æˆäº¤é¢</th>
                        <th style="width: 100px;">å¤æƒçŠ¶æ€</th>
                        <th style="width: 200px;">PE/PS/PB 1å¹´åˆ†ä½å€¼</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr>
                        <td>{{ trade.date }}</td>
                        <td>{{ "%.1f"|format(trade.open) }}</td>
                        <td>{{ "%.1f"|format(trade.high) }}</td>
                        <td>{{ "%.1f"|format(trade.low) }}</td>
                        <td>{{ "%.1f"|format(trade.close) }}</td>
                        <td>{{ "%.2f"|format(trade.volume / 10000) }} ä¸‡</td>
                        <td>{{ ("%.2f"|format(trade.amount / 100000000) + ' äº¿') if trade.amount >= 100000000 else ("%.2f"|format(trade.amount / 10000) + ' ä¸‡') }}</td>
                        <td>{{ 'åå¤æƒ' if trade.adjustflag == 1 else 'ä¸å¤æƒ' }}</td>
                        <td>{{ ("%.1f"|format(trade.pe_year_1_percent) + '%') if trade.pe_year_1_percent else '-' }} -
                            {{ ("%.1f"|format(trade.ps_year_1_percent) + '%') if trade.ps_year_1_percent else '-' }} -
                            {{ ("%.1f"|format(trade.pb_year_1_percent) + '%') if trade.pb_year_1_percent else '-' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="back-link">
            <a href="{{ url_for('nostock_basic_page') }}">è¿”å›éGPåŸºæœ¬ä¿¡æ¯åˆ—è¡¨</a>
        </div>
    </div>

    <script>
        // ä»é¡µé¢æ•°æ®ä¸­æå–å®Œæ•´çš„äº¤æ˜“æ•°æ®
        const fullTradeData = [
            {% for trade in trades %}
                {
                    date: '{{ trade.date }}',
                    low: {{ trade.low }},
                    high: {{ trade.high }},
                    open: {{ trade.open }},
                    close: {{ trade.close }},
                    volume: {{ trade.volume }},
                    amount: {{ trade.amount }},
                    pe_year_1_percent: {{ trade.pe_year_1_percent if trade.pe_year_1_percent is not none else '50' }},
                    ps_year_1_percent: {{ trade.ps_year_1_percent if trade.ps_year_1_percent is not none else '50' }},
                    pb_year_1_percent: {{ trade.pb_year_1_percent if trade.pb_year_1_percent is not none else '50' }},
                    pe_year_3_percent: {{ trade.pe_year_3_percent if trade.pe_year_3_percent is not none else '50' }},
                    ps_year_3_percent: {{ trade.ps_year_3_percent if trade.ps_year_3_percent is not none else '50' }},
                    pb_year_3_percent: {{ trade.pb_year_3_percent if trade.pb_year_3_percent is not none else '50' }},
                    pe_year_5_percent: {{ trade.pe_year_5_percent if trade.pe_year_5_percent is not none else '50' }},
                    ps_year_5_percent: {{ trade.ps_year_5_percent if trade.ps_year_5_percent is not none else '50' }},
                    pb_year_5_percent: {{ trade.pb_year_5_percent if trade.pb_year_5_percent is not none else '50' }},
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // æ•°æ®èšåˆå‡½æ•°
        function aggregateData(data, unit) {
            const aggregated = {};
            
            data.forEach(item => {
                let key;
                const date = moment(item.date);
                
                switch(unit) {
                      case 'week':
                         // æŒ‰å‘¨èšåˆï¼Œæ ¼å¼ï¼šYYYY-WW
                         key = date.format('YYYY-[W]WW');
                          break;
                    case 'month':
                        // æŒ‰æœˆèšåˆï¼Œæ ¼å¼ï¼šYYYY-MM
                        key = date.format('YYYY-MM');
                        break;
                    case 'quarter':
                        // æŒ‰å­£èšåˆï¼Œæ ¼å¼ï¼šYYYY-Qn
                        const quarter = Math.floor((date.month() + 3) / 3);
                        key = date.format('YYYY') + '-Q' + quarter;
                        break;
                    case 'day':
                    default:
                        // æŒ‰æ—¥èšåˆï¼Œç›´æ¥ä½¿ç”¨æ—¥æœŸ
                        key = item.date;
                        break;
                }
                
                if (!aggregated[key]) {
                    aggregated[key] = {
                        date: key,
                        // ä¿å­˜æ¯å‘¨çš„ç¬¬ä¸€ä¸ªå®é™…æ—¥æœŸï¼Œç”¨äºå‘¨æ•°æ®çš„æ˜¾ç¤º
                        displayDate: unit === 'week' ? item.date : key,
                        firstOpen: item.open,
                        lastClose: item.close,
                        minLow: item.low,
                        maxHigh: item.high,
                        totalVolume: item.volume,
                        totalAmount: item.amount,
                        pe_year_1_percent: item.pe_year_1_percent,
                        ps_year_1_percent: item.ps_year_1_percent,
                        pb_year_1_percent: item.pb_year_1_percent,
                        pe_year_3_percent: item.pe_year_3_percent,
                        ps_year_3_percent: item.ps_year_3_percent,
                        pb_year_3_percent: item.pb_year_3_percent,
                        pe_year_5_percent: item.pe_year_5_percent,
                        ps_year_5_percent: item.ps_year_5_percent,
                        pb_year_5_percent: item.pb_year_5_percent,
                        count: 1
                    };
                } else {
                    aggregated[key].minLow = Math.min(aggregated[key].minLow, item.low);
                    aggregated[key].maxHigh = Math.max(aggregated[key].maxHigh, item.high);
                    aggregated[key].totalVolume += item.volume;
                    aggregated[key].totalAmount += item.amount;
                    aggregated[key].lastClose = item.close;
                    aggregated[key].count += 1;
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const result = Object.values(aggregated).sort((a, b) => {
                // å¯¹äºéæ—¥æ•°æ®ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†æ’åº
                if (unit === 'week') {
                    return a.date.localeCompare(b.date);
                } else if (unit === 'month') {
                    return a.date.localeCompare(b.date);
                } else if (unit === 'quarter') {
                    return a.date.localeCompare(b.date);
                }
                return a.date.localeCompare(b.date);
            });
            
            // å½“æ—¶é—´å•ä½ä¸ºæ—¥æ—¶ï¼Œä»…æ˜¾ç¤ºæœ€è¿‘3å¹´çš„æ•°æ®
            if (unit === 'day') {
                const threeYearsAgo = moment().subtract(3, 'years').format('YYYY-MM-DD');
                const recentThreeYearsData = result.filter(item => item.date >= threeYearsAgo);
                return recentThreeYearsData;
            }
            
            return result;
        }
        
        // å®‰å…¨åˆå§‹åŒ–Kçº¿å›¾ï¼Œæ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—
        function safeInitKlineChart() {
            console.log('=== å¼€å§‹å®‰å…¨åˆå§‹åŒ–Kçº¿å›¾ ===');
            const startTime = performance.now();
            
            // ä½¿ç”¨æ–°çš„èµ„æºçŠ¶æ€å¯¹è±¡æ£€æŸ¥Chart.js
            if (!window.resourceStatus || !window.resourceStatus.chartjs || !window.resourceStatus.chartjs.loaded) {
                console.error('âŒ Chart.jsæœªåŠ è½½ï¼Œæ— æ³•åˆå§‹åŒ–Kçº¿å›¾', {
                    status: window.resourceStatus ? window.resourceStatus.chartjs : 'æœªåˆå§‹åŒ–'
                });
                
                // åœ¨å›¾è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const container = document.getElementById('klineChart');
                if (container && container.parentElement) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'chart-error';
                    errorDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 14px; text-align: center;';
                    errorDiv.textContent = 'å›¾è¡¨åŠ è½½å¤±è´¥: Chart.jsèµ„æºæœªå°±ç»ª';
                    container.parentElement.style.position = 'relative';
                    container.parentElement.appendChild(errorDiv);
                }
                return false;
            }
            console.log('âœ… Chart.jså·²åŠ è½½ï¼Œç‰ˆæœ¬ä¿¡æ¯:', Chart.version || 'æœªçŸ¥ç‰ˆæœ¬');
            
            // éªŒè¯Chart.jsåŠŸèƒ½å®Œæ•´æ€§
            try {
                // ç®€åŒ–éªŒè¯é€»è¾‘ï¼Œåªæ£€æŸ¥æœ€åŸºæœ¬çš„åŠŸèƒ½
                // Chart.jsçš„æŸäº›ç‰ˆæœ¬æˆ–åŠ è½½æ–¹å¼å¯èƒ½ä¸åŒ…å«pluginsä½†ä»å¯åˆ›å»ºåŸºæœ¬å›¾è¡¨
                const minimalRequiredProperties = ['defaults'];
                let isFunctional = true;
                
                minimalRequiredProperties.forEach(prop => {
                    if (!(prop in Chart)) {
                        console.warn(`âš ï¸ Chart.jså¯èƒ½ä¸å®Œæ•´: ç¼ºå°‘${prop}`);
                        // ä¸å†ç›´æ¥è¿”å›falseï¼Œè€Œæ˜¯ç»§ç»­å°è¯•
                    }
                });
                
                // æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—®æ„é€ å‡½æ•°
                if (typeof Chart !== 'function') {
                    console.error('âŒ Chart.jsæ— æ³•è®¿é—®æ„é€ å‡½æ•°');
                    return false;
                }
                
                console.log('âœ… Chart.jsåŸºæœ¬åŠŸèƒ½éªŒè¯é€šè¿‡');
            } catch (e) {
                console.error('âŒ éªŒè¯Chart.jså®Œæ•´æ€§æ—¶å‡ºé”™:', e);
                // å³ä½¿éªŒè¯å‡ºé”™ä¹Ÿç»§ç»­å°è¯•ï¼Œä½¿ç”¨ç®€åŒ–é…ç½®
                console.warn('âš ï¸ å°†ä½¿ç”¨ç®€åŒ–é…ç½®ç»§ç»­å°è¯•');
            }
            
            // æ£€æŸ¥å›¾è¡¨å®¹å™¨
            const ctx = document.getElementById('klineChart');
            if (!ctx) {
                console.error('âŒ Kçº¿å›¾å®¹å™¨ä¸å­˜åœ¨');
                return false;
            }
            console.log('âœ… Kçº¿å›¾å®¹å™¨å­˜åœ¨ï¼Œè·å–ä¸Šä¸‹æ–‡');
            
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„é”™è¯¯æç¤º
            const existingError = ctx.parentElement.querySelector('.chart-error');
            if (existingError) {
                existingError.remove();
            }
            
            // æ£€æŸ¥æ•°æ®
            if (!fullTradeData || fullTradeData.length === 0) {
                console.error('âŒ æ²¡æœ‰äº¤æ˜“æ•°æ®ï¼Œæ— æ³•åˆå§‹åŒ–å›¾è¡¨');
                return false;
            }
            console.log('âœ… äº¤æ˜“æ•°æ®å­˜åœ¨ï¼Œé•¿åº¦:', fullTradeData.length);
            
            try {
                // åˆå§‹åŒ–å‰é”€æ¯å¯èƒ½å­˜åœ¨çš„å›¾è¡¨
                if (window.klineChart) {
                    console.log('ğŸ”„ é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹...');
                    try {
                        // å®‰å…¨åœ°é”€æ¯å›¾è¡¨å®ä¾‹
                        if (window.klineChart && typeof window.klineChart.destroy === 'function') {
                            window.klineChart.destroy();
                        } else {
                            console.warn('âš ï¸ å›¾è¡¨å®ä¾‹ä¸åŒ…å«destroyæ–¹æ³•ï¼Œç›´æ¥é‡ç½®');
                        }
                    } catch (destroyError) {
                        console.error('âš ï¸ é”€æ¯å›¾è¡¨å®ä¾‹æ—¶å‡ºé”™:', destroyError);
                    } finally {
                        // æ— è®ºå¦‚ä½•éƒ½é‡ç½®å®ä¾‹
                        window.klineChart = null;
                    }
                }
                
                // åˆå§‹åŒ–æ—¶ä½¿ç”¨æ—¥æ•°æ®
                const initialData = aggregateData(fullTradeData, 'day');
                console.log('ğŸ“Š Kçº¿å›¾åˆå§‹æ•°æ®é•¿åº¦:', initialData.length);
                
                // æ£€æŸ¥æ•°æ®è´¨é‡
                if (initialData.length === 0) {
                    console.error('âŒ èšåˆåçš„æ•°æ®ä¸ºç©º');
                    return false;
                }
                console.log('ğŸ“ˆ æ•°æ®æ ·æœ¬æ£€æŸ¥:', {
                    firstItem: initialData[0],
                    lastItem: initialData[initialData.length - 1]
                });
                
                // å¯¹äºå‘¨æ•°æ®ï¼Œä½¿ç”¨displayDateå­—æ®µæ˜¾ç¤ºç¬¬ä¸€ä¸ªæ•°æ®çš„æ—¥æœŸ
                const labels = initialData.map(item => item.displayDate || item.date);
                
                // ä¼˜åŒ–æ•°æ®å¤„ç†ï¼Œç¡®ä¿æŠ˜çº¿å›¾æ˜¾ç¤ºæ­£å¸¸
                // ä¿ç•™åŸå§‹ç²¾åº¦ï¼Œä¸è¿›è¡Œå››èˆäº”å…¥
                const highData = initialData.map(item => item.maxHigh);
                
                // ä¼˜åŒ–é«˜ä½å·®ä»·è®¡ç®—ï¼Œä½¿ç”¨é€‚å½“çš„ç³»æ•°ï¼Œä¿æŒåŸå§‹ç²¾åº¦
                const DIFF_COEFFICIENT = 3; // é™ä½ç³»æ•°ä»¥ç¡®ä¿æŠ˜çº¿æ›´æ¥è¿‘
                const highLowDiffData = initialData.map(item => (item.maxHigh - item.minLow) * DIFF_COEFFICIENT);
                
                // æˆäº¤é¢æ•°æ®å¤„ç†
                const amountData = initialData.map(item => parseFloat((item.totalAmount / 100000000).toFixed(2)));
                
                console.log('ğŸ“Š å›¾è¡¨æ•°æ®å‡†å¤‡å®Œæˆ:', {
                    labelsCount: labels.length,
                    highDataRange: {
                        min: Math.min(...highData),
                        max: Math.max(...highData)
                    },
                    diffDataRange: {
                        min: Math.min(...highLowDiffData),
                        max: Math.max(...highLowDiffData)
                    }
                });
                
                // åˆ›å»ºå›¾è¡¨å®ä¾‹ - ä½¿ç”¨ä¼˜åŒ–çš„é…ç½®
                console.log('ğŸ”„ å¼€å§‹åˆ›å»ºChart.jså®ä¾‹...');
                
                window.klineChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                        {
                            label: 'æœ€é«˜ä»·',
                            data: highData,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2, // å¢åŠ çº¿æ¡å®½åº¦ï¼Œæé«˜å¯è§æ€§
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y',
                            pointRadius: 0.5, // æ·»åŠ å°æ•°æ®ç‚¹ï¼Œæé«˜å¯è§æ€§
                            pointHoverRadius: 4
                        },
                        {
                            label: 'é«˜ä½å·®ä»·',
                            data: highLowDiffData,
                            borderColor: 'rgb(255, 99, 132)', // ä½¿ç”¨æ›´æ˜æ˜¾çš„é¢œè‰²
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2, // å¢åŠ çº¿æ¡å®½åº¦
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y',
                            pointRadius: 0.5,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'æˆäº¤é¢(äº¿)',
                            data: amountData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderWidth: 1,
                            fill: true,
                            type: 'bar',
                            yAxisID: 'y1'
                        }
                    ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000 // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        stacked: false,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ'
                                },
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 10,
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                reverse: false // ä¸åè½¬æ—¶é—´è½´é¡ºåº
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'ä»·æ ¼'
                                },
                                min: function(context) {
                                    // åŠ¨æ€è®¾ç½®Yè½´æœ€å°å€¼ï¼Œç¡®ä¿æŠ˜çº¿å›¾å®Œæ•´æ˜¾ç¤º
                                    const chart = context.chart;
                                    let min = Infinity;
                                    chart.data.datasets.forEach(dataset => {
                                        if (dataset.yAxisID === 'y') {
                                            const datasetMin = Math.min(...dataset.data);
                                            min = Math.min(min, datasetMin);
                                        }
                                    });
                                    return min * 0.9; // ç•™å‡º10%çš„è¾¹è·
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'æˆäº¤é¢(äº¿)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                }
                            },
                            zoom: {
                                pan: {
                                    enabled: true,
                                    mode: 'x'
                                },
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'x',
                                }
                            }
                        }
                    }
                });
                
                // éªŒè¯å›¾è¡¨å®ä¾‹åˆ›å»ºæˆåŠŸ
                console.log('âœ… Kçº¿å›¾å®ä¾‹åˆ›å»ºæˆåŠŸ:', {
                    chartType: window.klineChart?.config?.type,
                    datasetsCount: window.klineChart?.data?.datasets?.length,
                    labelsCount: window.klineChart?.data?.labels?.length
                });
                
                // å°è¯•æ‰‹åŠ¨è§¦å‘å›¾è¡¨æ›´æ–°
                if (window.klineChart) {
                    console.log('ğŸ”„ æ‰‹åŠ¨è§¦å‘å›¾è¡¨æ›´æ–°...');
                    window.klineChart.update();
                }
                
                const endTime = performance.now();
                console.log(`âœ… Kçº¿å›¾å®‰å…¨åˆå§‹åŒ–å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                return true;
            } catch (error) {
                console.error('âŒ Kçº¿å›¾åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', {
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                
                // åœ¨å›¾è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (ctx && ctx.parentElement) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'chart-error';
                    errorDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 14px; text-align: center; padding: 10px; background: rgba(255, 255, 255, 0.9); border-radius: 4px;';
                    errorDiv.textContent = `å›¾è¡¨åŠ è½½å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                    ctx.parentElement.style.position = 'relative';
                    ctx.parentElement.appendChild(errorDiv);
                }
                
                // å°è¯•ä½¿ç”¨æåº¦ç®€åŒ–çš„é…ç½®é‡è¯•
                try {

                    
                    // è·å–åˆå§‹æ•°æ®
                    const initialData = aggregateData(fullTradeData, 'day');
                    if (initialData.length === 0) return false;
                    
                    // ç®€åŒ–é…ç½® - ä»…åŒ…å«æœ€åŸºæœ¬åŠŸèƒ½
                    const simplifiedConfig = {
                        type: 'line',
                        data: {
                            labels: initialData.slice(0, 100).map(item => item.displayDate || item.date),
                            datasets: [{
                                label: 'è‚¡ä»·',
                                data: initialData.slice(0, 100).map(item => item.maxHigh || parseFloat(item.high)),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true },
                                tooltip: { enabled: true }
                            }
                        }
                    };
                    
                    // é”€æ¯å¯èƒ½åˆ›å»ºäº†ä¸€åŠçš„å®ä¾‹
                    if (window.klineChart) {
                        try {
                            window.klineChart.destroy();
                        } catch (e) {}
                        window.klineChart = null;
                    }
                    
                    window.klineChart = new Chart(ctx.getContext('2d'), simplifiedConfig);

                    return true;
                } catch (simplifiedError) {
    
                }
                
                return false;
            }
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateChart(unit) {
            const aggregatedData = aggregateData(fullTradeData, unit);
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            // å¯¹äºå‘¨æ•°æ®ï¼Œä½¿ç”¨displayDateå­—æ®µæ˜¾ç¤ºç¬¬ä¸€ä¸ªæ•°æ®çš„æ—¥æœŸ
            const labels = aggregatedData.map(item => item.displayDate || item.date);
            // å»æ‰æœ€é«˜çš„å°æ•°ç‚¹
            const highData = aggregatedData.map(item => Math.round(item.maxHigh));
            // æ ¹æ®æ—¶é—´å•ä½é€‰æ‹©ä¸åŒçš„ç³»æ•°ï¼Œä½¿é«˜ä½å·®ä»·æŠ˜çº¿ä¸æœ€é«˜æŠ˜çº¿è·ç¦»æ›´æ¥è¿‘
            let DIFF_COEFFICIENT = 5; // æ—¥æ•°æ®çš„é»˜è®¤ç³»æ•°
            if (unit === 'week') {
                DIFF_COEFFICIENT = 8; // å‘¨æ•°æ®çš„ç³»æ•°ï¼Œä½¿è·ç¦»æ›´æ¥è¿‘
            } else if (unit === 'month') {
                DIFF_COEFFICIENT = 15; // æœˆæ•°æ®çš„ç³»æ•°ï¼Œä½¿è·ç¦»æ›´æ¥è¿‘
            } else if (unit === 'quarter') {
                DIFF_COEFFICIENT = 25; // å­£æ•°æ®çš„ç³»æ•°ï¼Œä½¿è·ç¦»æ›´æ¥è¿‘
            }
            
            // è®¡ç®—é«˜ä½å·®ä»·å¹¶åº”ç”¨ç³»æ•°
            const highLowDiffData = aggregatedData.map(item => Math.round((item.maxHigh - item.minLow) * DIFF_COEFFICIENT / item.count));
            // å°†æˆäº¤é¢è½¬æ¢ä¸ºä»¥äº¿ä¸ºå•ä½
            const amountData = aggregatedData.map(item => parseFloat((item.totalAmount / 100000000).toFixed(2)));
            
            // ä½¿ç”¨å…¨å±€çš„klineChartå¯¹è±¡
            if (window.klineChart) {
                window.klineChart.data.labels = labels;
                window.klineChart.data.datasets[0].data = highData;
                window.klineChart.data.datasets[1].data = highLowDiffData;
                window.klineChart.data.datasets[2].data = amountData;
                
                // æ›´æ–°å›¾è¡¨æ ‡é¢˜
                let title = 'æ—¥Kæ•°æ®';
                switch(unit) {
                    case 'week':
                        title = 'å‘¨Kæ•°æ®';
                        break;
                    case 'month':
                        title = 'æœˆKæ•°æ®';
                        break;
                    case 'quarter':
                        title = 'å­£Kæ•°æ®';
                        break;
                }
                document.querySelector('.stock-info h1').textContent = 
                    '{{ stock_name }} ({{ stock_code }}) ' + title;
                
                // ç¡®ä¿æ—¶é—´è½´ä»å·¦åˆ°å³ä¸ºä»è¿œåˆ°è¿‘çš„æ—¥æœŸ
                window.klineChart.options.scales.x.reverse = false;
                
                window.klineChart.update();
            } else {
    
            }
        }

        // é‡ç½®ç¼©æ”¾æŒ‰é’®äº‹ä»¶
        document.getElementById('resetZoom').addEventListener('click', function() {
            if (window.klineChart) {
                window.klineChart.resetZoom();
            }
            if (window.oneYearPercentChart) {
                window.oneYearPercentChart.resetZoom();
            }
            if (window.threeYearPercentChart) {
                window.threeYearPercentChart.resetZoom();
            }
            if (window.fiveYearPercentChart) {
                window.fiveYearPercentChart.resetZoom();
            }
        });
        
        // æ—¶é—´å•ä½é€‰æ‹©å™¨äº‹ä»¶
        document.getElementById('timeUnit').addEventListener('change', function(e) {
            const selectedUnit = e.target.value;
            updateChart(selectedUnit);
            updatePercentCharts(selectedUnit);
        });

        // åˆå§‹åŒ–åˆ†ä½å€¼å›¾è¡¨
        function initPercentCharts() {

            // å‡†å¤‡åˆå§‹æ•°æ®
            const initialData = aggregateData(fullTradeData, 'day');
            const labels = initialData.map(item => item.displayDate || item.date);



            // å‡†å¤‡å„ç±»å‹æ•°æ®
            const peData = preparePercentDataset(initialData, 'pe');
            const psData = preparePercentDataset(initialData, 'ps');
            const pbData = preparePercentDataset(initialData, 'pb');




            // åˆå§‹åŒ–1å¹´PE&PS&PBåˆ†ä½å€¼å›¾è¡¨
            const oneYearCtx = document.getElementById('oneYearPercentChart').getContext('2d');
            
            window.oneYearPercentChart = new Chart(oneYearCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'PEåˆ†ä½å€¼',
                            data: peData.year1,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'PSåˆ†ä½å€¼',
                            data: psData.year1,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'PBåˆ†ä½å€¼',
                            data: pbData.year1,
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'åˆ†ä½å€¼(%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });

            // åˆå§‹åŒ–3å¹´PE&PS&PBåˆ†ä½å€¼å›¾è¡¨
            const threeYearCtx = document.getElementById('threeYearPercentChart').getContext('2d');
            
            window.threeYearPercentChart = new Chart(threeYearCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'PEåˆ†ä½å€¼',
                            data: peData.year3,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'PSåˆ†ä½å€¼',
                            data: psData.year3,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'PBåˆ†ä½å€¼',
                            data: pbData.year3,
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'åˆ†ä½å€¼(%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });

            // åˆå§‹åŒ–5å¹´PE&PS&PBåˆ†ä½å€¼å›¾è¡¨
            const fiveYearCtx = document.getElementById('fiveYearPercentChart').getContext('2d');
            
            window.fiveYearPercentChart = new Chart(fiveYearCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'PEåˆ†ä½å€¼',
                            data: peData.year5,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'PSåˆ†ä½å€¼',
                            data: psData.year5,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'PBåˆ†ä½å€¼',
                            data: pbData.year5,
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'åˆ†ä½å€¼(%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });
        }

        // å‡†å¤‡åˆ†ä½å€¼æ•°æ®é›†
        function preparePercentDataset(data, type) {
            console.log(`å‡†å¤‡${type}åˆ†ä½å€¼æ•°æ®é›†...`);
            const year1 = [];
            const year3 = [];
            const year5 = [];

            data.forEach(item => {
                // ä½¿ç”¨é»˜è®¤å€¼50æ›¿ä»£nullï¼Œä¸HTMLæ¨¡æ¿ä¸­çš„é»˜è®¤å€¼ä¿æŒä¸€è‡´
                const y1 = item[`${type}_year_1_percent`] !== null && item[`${type}_year_1_percent`] !== undefined ? item[`${type}_year_1_percent`] : 50;
                const y3 = item[`${type}_year_3_percent`] !== null && item[`${type}_year_3_percent`] !== undefined ? item[`${type}_year_3_percent`] : 50;
                const y5 = item[`${type}_year_5_percent`] !== null && item[`${type}_year_5_percent`] !== undefined ? item[`${type}_year_5_percent`] : 50;
                
                year1.push(y1);
                year3.push(y3);
                year5.push(y5);
                
                // è®°å½•ç¬¬ä¸€ä¸ªæ•°æ®é¡¹çš„è¯¦ç»†ä¿¡æ¯
                if (year1.length === 1) {
                    console.log(`${type}æ•°æ®å­—æ®µæ£€æŸ¥:`, {
                        y1: y1,
                        y3: y3,
                        y5: y5,
                        hasYear1Percent: `${type}_year_1_percent` in item,
                        hasYear3Percent: `${type}_year_3_percent` in item,
                        hasYear5Percent: `${type}_year_5_percent` in item
                    });
                }
            });
            
            const result = { year1, year3, year5 };
            console.log(`${type}åˆ†ä½å€¼æ•°æ®é›†å‡†å¤‡å®Œæˆ:`, {
                year1Length: year1.length,
                year1Sample: year1.slice(0, 3),
                year3Sample: year3.slice(0, 3),
                year5Sample: year5.slice(0, 3)
            });
            
            return result;
        }

        // è·å–åˆ†ä½å€¼å›¾è¡¨é€‰é¡¹
        function getPercentChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'æ—¥æœŸ'
                        },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10
                        },
                        reverse: false
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'åˆ†ä½å€¼(%)'
                        },
                        min: 0,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + '%';
                            }
                        }
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x'
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        }
                    }
                }
            };
        }

        // æ›´æ–°åˆ†ä½å€¼å›¾è¡¨
        function updatePercentCharts(unit) {
            const aggregatedData = aggregateData(fullTradeData, unit);
            const labels = aggregatedData.map(item => item.displayDate || item.date);
            
            // å‡†å¤‡å„ç±»å‹æ•°æ®
            const peData = preparePercentDataset(aggregatedData, 'pe');
            const psData = preparePercentDataset(aggregatedData, 'ps');
            const pbData = preparePercentDataset(aggregatedData, 'pb');
            
            // æ›´æ–°1å¹´åˆ†ä½å€¼å›¾è¡¨
            if (window.oneYearPercentChart) {
                window.oneYearPercentChart.data.labels = labels;
                window.oneYearPercentChart.data.datasets[0].data = peData.year1;
                window.oneYearPercentChart.data.datasets[1].data = psData.year1;
                window.oneYearPercentChart.data.datasets[2].data = pbData.year1;
                window.oneYearPercentChart.update();
            }
            
            // æ›´æ–°3å¹´åˆ†ä½å€¼å›¾è¡¨
            if (window.threeYearPercentChart) {
                window.threeYearPercentChart.data.labels = labels;
                window.threeYearPercentChart.data.datasets[0].data = peData.year3;
                window.threeYearPercentChart.data.datasets[1].data = psData.year3;
                window.threeYearPercentChart.data.datasets[2].data = pbData.year3;
                window.threeYearPercentChart.update();
            }
            
            // æ›´æ–°5å¹´åˆ†ä½å€¼å›¾è¡¨
            if (window.fiveYearPercentChart) {
                window.fiveYearPercentChart.data.labels = labels;
                window.fiveYearPercentChart.data.datasets[0].data = peData.year5;
                window.fiveYearPercentChart.data.datasets[1].data = psData.year5;
                window.fiveYearPercentChart.data.datasets[2].data = pbData.year5;
                window.fiveYearPercentChart.update();
            }
        }

        // ä¼˜åŒ–å›¾è¡¨åˆå§‹åŒ–å‡½æ•°ï¼Œæ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—
        function safeInitPercentCharts() {
            console.log('=== å¼€å§‹å®‰å…¨åˆå§‹åŒ–åˆ†ä½å€¼å›¾è¡¨ ===');
            const startTime = performance.now();
            
            // ä½¿ç”¨æ–°çš„èµ„æºçŠ¶æ€å¯¹è±¡æ£€æŸ¥Chart.js
            if (!window.resourceStatus || !window.resourceStatus.chartjs || !window.resourceStatus.chartjs.loaded) {
                console.error('âŒ Chart.jsæœªåŠ è½½ï¼Œæ— æ³•åˆå§‹åŒ–åˆ†ä½å€¼å›¾è¡¨', {
                    status: window.resourceStatus ? window.resourceStatus.chartjs : 'æœªåˆå§‹åŒ–'
                });
                
                // åœ¨å›¾è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const containers = ['oneYearPercentChart', 'threeYearPercentChart', 'fiveYearPercentChart'];
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container && container.parentElement) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'chart-error';
                        errorDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 14px; text-align: center;';
                        errorDiv.textContent = 'å›¾è¡¨åŠ è½½å¤±è´¥: Chart.jsèµ„æºæœªå°±ç»ª';
                        container.parentElement.style.position = 'relative';
                        container.parentElement.appendChild(errorDiv);
                    }
                });
                return false;
            }
            console.log('âœ… Chart.jså·²åŠ è½½ï¼Œç‰ˆæœ¬ä¿¡æ¯:', Chart.version || 'æœªçŸ¥ç‰ˆæœ¬');
            console.log('âœ… Chartå¯¹è±¡å±æ€§æ£€æŸ¥:', {
                plugins: typeof Chart.plugins === 'object' ? Object.keys(Chart.plugins) : 'ä¸å­˜åœ¨',
                defaults: typeof Chart.defaults === 'object' ? Object.keys(Chart.defaults).slice(0, 5) + '...' : 'ä¸å­˜åœ¨',
                register: typeof Chart.register === 'function',
                unregister: typeof Chart.unregister === 'function'
            });
            
            // æ£€æŸ¥å›¾è¡¨å®¹å™¨
            const containers = [
                { id: 'oneYearPercentChart', name: '1å¹´åˆ†ä½å€¼å›¾è¡¨' },
                { id: 'threeYearPercentChart', name: '3å¹´åˆ†ä½å€¼å›¾è¡¨' },
                { id: 'fiveYearPercentChart', name: '5å¹´åˆ†ä½å€¼å›¾è¡¨' }
            ];
            
            let allContainersExist = true;
            const containerStatus = {};
            
            containers.forEach(container => {
                const element = document.getElementById(container.id);
                containerStatus[container.name] = {
                    exists: !!element,
                    width: element ? element.offsetWidth : 0,
                    height: element ? element.offsetHeight : 0
                };
                
                if (!element) {
                    console.error(`âŒ ${container.name}å®¹å™¨ä¸å­˜åœ¨`);
                    allContainersExist = false;
                } else {
                    console.log(`âœ… ${container.name}å®¹å™¨å­˜åœ¨ï¼Œå°ºå¯¸: ${element.offsetWidth}x${element.offsetHeight}`);
                }
            });
            
            console.log('å›¾è¡¨å®¹å™¨çŠ¶æ€æ±‡æ€»:', containerStatus);
            
            if (!allContainersExist) {
                console.error('âŒ éƒ¨åˆ†å›¾è¡¨å®¹å™¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆå§‹åŒ–');
                return false;
            }
            
            // æ£€æŸ¥æ•°æ®
            console.log('æ•°æ®æ£€æŸ¥:', {
                fullTradeData: !!fullTradeData,
                dataType: typeof fullTradeData,
                dataLength: fullTradeData ? fullTradeData.length : 0
            });
            
            if (!fullTradeData || fullTradeData.length === 0) {
                console.error('âŒ æ²¡æœ‰äº¤æ˜“æ•°æ®ï¼Œæ— æ³•åˆå§‹åŒ–å›¾è¡¨');
                return false;
            }
            
            // æ£€æŸ¥è¾…åŠ©å‡½æ•°
            console.log('è¾…åŠ©å‡½æ•°æ£€æŸ¥:', {
                initPercentCharts: typeof initPercentCharts === 'function',
                preparePercentDataset: typeof preparePercentDataset === 'function',
                getPercentChartOptions: typeof getPercentChartOptions === 'function',
                aggregateData: typeof aggregateData === 'function'
            });
            
            try {
                // æ‰§è¡Œåˆå§‹åŒ–
                console.log('ğŸ”„ å¼€å§‹æ‰§è¡ŒinitPercentCharts()...');
                initPercentCharts();
                
                // éªŒè¯å›¾è¡¨å®ä¾‹
                const chartInstances = {
                    oneYearPercentChart: !!window.oneYearPercentChart,
                    threeYearPercentChart: !!window.threeYearPercentChart,
                    fiveYearPercentChart: !!window.fiveYearPercentChart
                };
                
                console.log('å›¾è¡¨å®ä¾‹åˆ›å»ºçŠ¶æ€:', chartInstances);
                
                const allChartsCreated = Object.values(chartInstances).every(Boolean);
                
                const endTime = performance.now();
                console.log(`âœ… åˆ†ä½å€¼å›¾è¡¨å®‰å…¨åˆå§‹åŒ–${allChartsCreated ? 'æˆåŠŸ' : 'éƒ¨åˆ†æˆåŠŸ'}ï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                
                return allChartsCreated;
            } catch (error) {
                console.error('âŒ å›¾è¡¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', {
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                
                // åœ¨æ‰€æœ‰å›¾è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const containers = ['oneYearPercentChart', 'threeYearPercentChart', 'fiveYearPercentChart'];
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container && container.parentElement) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'chart-error';
                        errorDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 14px; text-align: center; padding: 10px; background: rgba(255, 255, 255, 0.9); border-radius: 4px;';
                        errorDiv.textContent = `åˆ†ä½å€¼å›¾è¡¨åŠ è½½å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                        container.parentElement.style.position = 'relative';
                        container.parentElement.appendChild(errorDiv);
                    }
                });
                
                // å°è¯•ä½¿ç”¨ç®€åŒ–é…ç½®ä¸º1å¹´åˆ†ä½å€¼å›¾è¡¨åˆ›å»ºåŸºæœ¬æ˜¾ç¤º
                try {
                    console.log('ğŸ”„ å°è¯•ä½¿ç”¨ç®€åŒ–é…ç½®åˆ›å»ºåŸºæœ¬åˆ†ä½å€¼å›¾è¡¨');
                    
                    // ä¸º1å¹´å›¾è¡¨åˆ›å»ºæœ€åŸºæœ¬çš„æ˜¾ç¤º
                    const oneYearCtx = document.getElementById('oneYearPercentChart');
                    if (oneYearCtx) {
                        // ç®€åŒ–é…ç½®
                        const simplifiedConfig = {
                            type: 'bar',
                            data: {
                                labels: ['PEåˆ†ä½', 'PSåˆ†ä½', 'PBåˆ†ä½'],
                                datasets: [{
                                    label: '1å¹´åˆ†ä½å€¼',
                                    data: [50, 50, 50], // é»˜è®¤å€¼
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(75, 192, 192, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(255, 99, 132, 1)',
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(75, 192, 192, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    legend: { display: true },
                                    tooltip: { enabled: true }
                                }
                            }
                        };
                        
                        window.oneYearPercentChart = new Chart(oneYearCtx.getContext('2d'), simplifiedConfig);

                    }
                } catch (simplifiedError) {

                }
                
                return false;
            }
        }
        
        // å¢å¼ºç‰ˆå›¾è¡¨åˆå§‹åŒ–ç®¡ç†ç³»ç»Ÿ
        function setupChartInitialization() {

            let retryCount = 0;
            const maxRetries = 15; // å¢åŠ é‡è¯•æ¬¡æ•°åˆ°15æ¬¡
            const retryDelay = 1000; // æ¯æ¬¡é‡è¯•é—´éš”1ç§’
            let klineInitialized = false;
            let percentInitialized = false;
            
            // æ·»åŠ å…¨å±€åŠ è½½çŠ¶æ€å˜é‡
            window.chartInitializationState = {
                chartjsLoaded: false,
                chartjsVersion: null,
                momentLoaded: false,
                momentVersion: null,
                klineChart: null,
                percentCharts: {},
                initializationStartTime: Date.now(),
                initializationComplete: false
            };
            
            // å¢å¼ºçš„èµ„æºæ£€æŸ¥å‡½æ•°
            function checkResources() {
                const chartjsStatus = typeof Chart !== 'undefined';
                const momentStatus = typeof moment !== 'undefined';
                const dataStatus = typeof fullTradeData !== 'undefined' && fullTradeData && fullTradeData.length > 0;
                
                // æ›´æ–°å…¨å±€çŠ¶æ€
                window.chartInitializationState.chartjsLoaded = chartjsStatus;
                window.chartInitializationState.chartjsVersion = chartjsStatus ? (Chart.version || 'æœªçŸ¥ç‰ˆæœ¬') : null;
                window.chartInitializationState.momentLoaded = momentStatus;
                window.chartInitializationState.momentVersion = momentStatus ? (moment.version || 'æœªçŸ¥ç‰ˆæœ¬') : null;
                
                const status = {
                    chartjs: chartjsStatus,
                    chartjsVersion: window.chartInitializationState.chartjsVersion,
                    moment: momentStatus,
                    momentVersion: window.chartInitializationState.momentVersion,
                    data: dataStatus,
                    dom: document.readyState === 'complete' || document.readyState === 'interactive'
                };
                

                return status;
            }
            
            // å¢å¼ºçš„é”™è¯¯æ˜¾ç¤ºå‡½æ•°
            function showChartErrorMessage(message) {
                
                // ä¸ºæ¯ä¸ªå›¾è¡¨å®¹å™¨æ·»åŠ é”™è¯¯æ¶ˆæ¯
                const chartContainers = [
                    '#klineChartContainer',
                    '#oneYearPercentContainer',
                    '#threeYearPercentContainer',
                    '#fiveYearPercentContainer'
                ];
                
                chartContainers.forEach(selector => {
                    const container = document.querySelector(selector);
                    if (container) {
                        container.innerHTML = `
                            <div style="display: flex; justify-content: center; align-items: center;
                                        height: 100%; min-height: 200px; color: #dc3545;">
                                <div>
                                    <h4>å›¾è¡¨åŠ è½½å¤±è´¥</h4>
                                    <p>${message}</p>
                                    <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        åˆ·æ–°é¡µé¢é‡è¯•
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            // æ ¸å¿ƒåˆå§‹åŒ–å°è¯•å‡½æ•°
            function tryInitializeCharts() {
                retryCount++;

                
                // æ£€æŸ¥èµ„æºçŠ¶æ€
                const resources = checkResources();
                
                // åªæœ‰å½“æ ¸å¿ƒèµ„æºå¯ç”¨æ—¶æ‰å°è¯•åˆå§‹åŒ–
                if (resources.chartjs && resources.moment && resources.data && resources.dom) {

                    
                    try {
                        // åˆå§‹åŒ–Kçº¿å›¾
                        if (!klineInitialized) {

                            klineInitialized = safeInitKlineChart();
                            window.chartInitializationState.klineChart = window.klineChart || null;

                        }
                        
                        // åˆå§‹åŒ–åˆ†ä½å€¼å›¾è¡¨
                        if (!percentInitialized) {

                            percentInitialized = safeInitPercentCharts();
                            window.chartInitializationState.percentCharts = {
                                oneYear: window.oneYearPercentChart || null,
                                threeYear: window.threeYearPercentChart || null,
                                fiveYear: window.fiveYearPercentChart || null
                            };

                        }
                        
                        // å¦‚æœæ‰€æœ‰å›¾è¡¨éƒ½åˆå§‹åŒ–æˆåŠŸ
                        if (klineInitialized && percentInitialized) {

                            window.chartInitializationState.initializationComplete = true;
                            return true;
                        }
                    } catch (e) {

                    }
                }
                
                // å¦‚æœå°šæœªæˆåŠŸä¸”æœªè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œç»§ç»­é‡è¯•
                if (retryCount < maxRetries) {
                    let missingResources = [];
                    if (!resources.chartjs) missingResources.push('Chart.js');
                    if (!resources.moment) missingResources.push('Moment.js');
                    if (!resources.data) missingResources.push('äº¤æ˜“æ•°æ®');
                    if (!resources.dom) missingResources.push('DOMå°±ç»ª');
                    

                    setTimeout(tryInitializeCharts, retryDelay);
                } else {
                    // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

                    showChartErrorMessage('å›¾è¡¨èµ„æºåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                
                return false;
            }
            
            // æ·»åŠ Chart.jsåŠ¨æ€æ£€æµ‹
            function setupChartJsDynamicDetection() {
                // å¦‚æœChart.jså·²ç»åŠ è½½
                if (typeof Chart !== 'undefined') {

                    tryInitializeCharts();
                    return;
                }
                
                // å¦‚æœChart.jsæœªåŠ è½½ï¼Œè®¾ç½®åŠ¨æ€æ£€æµ‹
                
                const detectionInterval = setInterval(() => {
                    if (typeof Chart !== 'undefined') {
                        clearInterval(detectionInterval);

                        tryInitializeCharts();
                    } else if (retryCount >= maxRetries) {
                        clearInterval(detectionInterval);

                    }
                }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡
            }
            
            // å¼€å§‹åˆå§‹åŒ–æµç¨‹
            setupChartJsDynamicDetection();
        }
        
        // åœ¨DOMåŠ è½½å®Œæˆåè®¾ç½®å›¾è¡¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {

            setupChartInitialization();
        });
        
        // ä¹Ÿç›‘å¬çª—å£loadäº‹ä»¶ï¼Œç¡®ä¿æ‰€æœ‰èµ„æºéƒ½å·²åŠ è½½
        window.addEventListener('load', function() {

            // å¦‚æœå›¾è¡¨è¿˜æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
            if (!window.klineChart || !window.oneYearPercentChart) {

                setTimeout(setupChartInitialization, 500);
            }
        });
    </script>
</body>
</html>